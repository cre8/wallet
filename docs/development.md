# Development

## Requirements
- node v20 (https://nodejs.org/en/download/package-manager)
- pnpm v9
- enabled corepack via `corepack enable` (comes with node)


### Keycloak (OIDC provider)
to manage the user accounts from the cloud wallet, an OIDC provider is required. This repository offers a self hosted keycloak instance that you can use. It's a basic setup without a customized registration flow, so the user registers only with an email and password. Password reset is also possible via email, but the smtp credentials have to be set in the keycloak settings manually.

The realm is located in the `config/keycloak/realm-export.json` file. In case you want to use another keycloak instance, you can import the realm there. It should also be possible to use any other OIDC system.

In the default realm settings, there is no restriction to the origin of the requests and registration is open for everyone. There is also no implementation of keycloak or cloud wallet events like creating or deleting a user object.

Webauthn is implemented, but not configured for the registration. It can be added via settings page in the wallets. The primary authentication method is the password, since we do not want to rely on just one device for login for now.

## Development
To install all dependencies, run `pnpm install` in the root folder.

Each app has its own `package.json` with specific jobs. In the root folder is one `package.json` with global jobs like `build`, `clean` and `lint`.

The command `pnpm run -r init` will generate `.env` files for each app based on the example file. Applications inside the `apps` folder will not use the `.env` file in the root folder, this is only for the docker-compose setup. Instead use the `.env` files in the apps folder. In case it's an angular application, use the config file in the `assets/config` folder.

## Issuer
The issuer app is a rest api, supporting the oid4vci protocol. Right now there is only one demo credential available. Start the issuer with `pnpm run dev`. Don't forget to have an `.env` file in the folder to configure the application, it will not use the `.env` file in the root folder.

## Verifier
The verifier app is a rest api, supporting the oid4vp protocol. The verifier can verify the demo credential from the issuer. Start the verifier with `pnpm run dev`. Don't forget to have an `.env` file in the folder to configure the application, it will not use the `.env` file in the root folder.

## Wallet clients
This repository includes two clients. One is a progressive web app, the other one is a chrome browser extension. Both are managed via angular and share the same code base.

Since the backend is following the openAPI specification, an SDK to interact with it can be generated by running `pnpm run api`. To run this command, Java needs to be installed on the system.

### PWA Client
The command `pnpm run start:pwa` will run the application in the watch mode. It will start a web server on `localhost:4200` and reload when you changed the code. The configuration is managed in the `assets/config` folder. This approach allows a dynamic config since it can be mounted into the docker container without the need of recompiling it.

### Browser Plugin
The command `pnpm run start:extension` in the `holder` folder will watch on the build files. To use this plugin in the chrome browser during development, go to `chrome://extensions/` and enable developer mode. Then click on `Load unpacked` and select the `dist/browser-extension` folder in the `browser-extension` folder. To get the updates active, you need to reopen the plugin in the browser (hitting refresh on the plugin page is not required).

Angular is using the webpack compiler instead of the modern esbuild. This is required since we need to build multiple file like the main and background file and right now it is not possible to pass a custom esbuild config to angular.

## Backend
All endpoints are available via the `http://localhost:3000` address. A swagger endpoint is available at `http://localhost:3000/api` where you can authenticate with your keycloak user credentials. Don't forget to have an `.env` file in the folder to configure the application, it will not use the `.env` file in the root folder.

You can either use a postgres or sqlite database. In case of using postgres, there is one defined in the `docker-compose.yml` in the root folder. Don't forget to sync the credentials in the root `.env` file and the one in the backend folder to get a successful connection.